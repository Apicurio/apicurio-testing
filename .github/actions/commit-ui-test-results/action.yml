name: 'Commit UI Test Results'
description: 'Collects Playwright test results and commits them to the repository'
inputs:
  cluster-name:
    description: 'Name of the cluster'
    required: true
  namespace:
    description: 'Kubernetes namespace'
    required: true
  job-name:
    description: 'Name of the current job'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Collect and commit UI test results
      shell: bash
      run: |
        # Clone the results repository if it doesn't already exist
        if [ ! -d "workflow-results" ]; then
          git clone https://${{ inputs.github-token }}@github.com/Apicurio/apicurio-testing-results.git workflow-results
          cd workflow-results
          # Configure git for the results repository
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          cd ..
        else
          echo "workflow-results directory already exists, skipping clone"
        fi
        
        # Create directory structure in the results repository
        RUN_DATE=$(date +%Y-%m-%d)
        RESULTS_DIR="workflow-results/${RUN_DATE}-${{ github.run_id }}/${{ inputs.job-name }}"
        mkdir -p "$RESULTS_DIR/test-results"

        BASE_DIR="."
        CLUSTER_NAME=${{ inputs.cluster-name }}
        CLUSTER_DIR="$BASE_DIR/clusters/$CLUSTER_NAME"
        NAMESPACE=${{ inputs.namespace }}
        TESTS_DIR="$CLUSTER_DIR/namespaces/$NAMESPACE/tests"
        UI_TESTS_DIR="$TESTS_DIR/ui/apicurio-registry/ui/tests"

        echo "Looking for UI test results in: $UI_TESTS_DIR"
        echo "---"
        find $UI_TESTS_DIR
        echo "---"

        # Collect Playwright test results
        if [ -d "$UI_TESTS_DIR/playwright-report" ]; then
          cp -r $UI_TESTS_DIR/playwright-report/* "$RESULTS_DIR/test-results/" 2>/dev/null || true
          echo "Copied Playwright HTML report from $UI_TESTS_DIR/playwright-report/"
        fi

        # Collect test results JSON files
        if [ -d "$UI_TESTS_DIR/test-results" ]; then
          mkdir -p "$RESULTS_DIR/test-results/raw-results"
          cp -r $UI_TESTS_DIR/test-results/* "$RESULTS_DIR/test-results/raw-results/" 2>/dev/null || true
          echo "Copied Playwright raw test results from $UI_TESTS_DIR/test-results/"
        fi

        # Commit and push ui test results to the results repository
        cd workflow-results
        git pull origin main
        git add .
        if git diff --cached --quiet; then
          echo "No UI test results to commit."
        else
          git commit -m "Add UI test results for job ${{ inputs.job-name }} from workflow run ${{ github.run_id }}"
          git push origin main
        fi
        cd ..